<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Frame Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable manual toggling
            theme: {
                extend: {
                    colors: {
                        slate: {
                            50: '#f8fafc',
                            // ... other defaults
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        .sidebar-link.active {
            background-color: rgb(37 99 235 / 0.1);
            color: rgb(37 99 235);
            border-right: 3px solid rgb(37 99 235);
        }

        /* Dark Mode Active Link Override */
        .dark .sidebar-link.active {
            background-color: rgb(37 99 235 / 0.2);
            color: rgb(96 165 250);
            /* Blue-400 */
        }

        /* Hide scrollbar for chrome/safari/opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-black h-screen flex overflow-hidden transition-colors duration-300">
    <script>
        // Apply theme immediately to prevent flash
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <!-- ADMIN LOGIN OVERLAY -->
    <div id="admin-login-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-50 dark:bg-black">
        <div
            class="bg-white dark:bg-zinc-900 p-8 rounded-2xl shadow-xl w-full max-w-sm border border-slate-200 dark:border-zinc-800">
            <div class="text-center mb-8">
                <div
                    class="inline-block w-12 h-12 bg-blue-600/10 rounded-xl flex items-center justify-center mb-4 mx-auto text-blue-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Admin Access</h2>
                <p class="text-slate-500 dark:text-slate-400 text-sm">Restricted Area. Authorized Personnel Only.</p>
            </div>

            <form id="admin-login-form" class="space-y-4">
                <div>
                    <input type="email" id="admin-email" required placeholder="admin@example.com"
                        class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                </div>
                <div>
                    <input type="password" id="admin-password" required placeholder="Password"
                        class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                </div>
                <button type="submit" id="admin-login-btn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition-colors">
                    Login
                </button>
            </form>
            <p id="login-error" class="text-red-500 text-xs mt-4 text-center hidden"></p>
        </div>
    </div>

    <!-- Mobile Toggle -->
    <button id="mobile-menu-btn"
        class="md:hidden fixed top-4 left-4 z-40 p-2 bg-white dark:bg-zinc-900 rounded-lg shadow-lg text-slate-600 dark:text-slate-300">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
    </button>

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebar-overlay"
        class="fixed inset-0 z-20 bg-black/50 backdrop-blur-sm hidden md:hidden transition-opacity"></div>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed md:relative inset-y-0 left-0 w-64 bg-white dark:bg-zinc-950 border-r border-slate-200 dark:border-zinc-800 flex-shrink-0 flex flex-col z-30 shadow-xl transition-transform duration-300 transform -translate-x-full md:translate-x-0">
        <div class="h-16 flex items-center px-8 border-b border-slate-100 dark:border-zinc-800 justify-between">
            <div class="flex items-center">
                <div class="w-2 h-2 rounded-full bg-blue-600 mr-2"></div>
                <h1 class="text-xl font-bold text-slate-800 dark:text-white tracking-tight">Admin<span
                        class="text-blue-600">Panel</span></h1>
            </div>
            <!-- Mobile Close -->
            <button id="close-sidebar-btn" class="md:hidden text-slate-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 space-y-1">
            <!-- Navigation Links -->
            <a href="#" onclick="showClientsView(); return false;"
                class="sidebar-link flex items-center px-8 py-3 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white hover:bg-slate-50 dark:hover:bg-zinc-900 transition-all text-sm font-medium border-r-4 border-transparent active">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                Clients <span
                    class="ml-2 bg-blue-100 text-blue-800 text-[10px] font-bold px-1.5 py-0.5 rounded-full">MAIN</span>
            </a>
            <a href="#" onclick="showPlansView(); return false;"
                class="sidebar-link flex items-center px-8 py-3 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white hover:bg-slate-50 dark:hover:bg-zinc-900 transition-all text-sm font-medium border-r-4 border-transparent">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Manage Plans
            </a>
            <a href="#" onclick="showSiteContentView(); return false;"
                class="sidebar-link flex items-center px-8 py-3 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white hover:bg-slate-50 dark:hover:bg-zinc-900 transition-all text-sm font-medium border-r-4 border-transparent">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
                Site Content
            </a>

            <!-- EDITOR LINKS (Hidden by default, shown when editing project) -->
            <div id="editor-nav-links" class="hidden mt-8 pt-8 border-t border-slate-100 dark:border-zinc-800">
                <p class="px-8 text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Project Editor</p>
                <a href="#" onclick="closeEditor()"
                    class="flex items-center px-8 py-2 text-red-500 hover:text-red-700 text-xs font-bold mb-4 uppercase tracking-wider">
                    ← Back to Projects
                </a>

                <a href="#section-message"
                    class="sidebar-link flex items-center px-8 py-3 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white hover:bg-slate-50 dark:hover:bg-zinc-900 transition-all text-sm font-medium border-r-4 border-transparent">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    Main Details
                </a>
                <a href="#section-start"
                    class="sidebar-link flex items-center px-8 py-3 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white hover:bg-slate-50 dark:hover:bg-zinc-900 transition-all text-sm font-medium">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                    </svg>
                    Start Page
                </a>
                <a href="#section-message"
                    class="sidebar-link flex items-center px-8 py-3 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white hover:bg-slate-50 dark:hover:bg-zinc-900 transition-all text-sm font-medium">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    Message Card
                </a>
                <a href="#section-media"
                    class="sidebar-link flex items-center px-8 py-3 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white hover:bg-slate-50 dark:hover:bg-zinc-900 transition-all text-sm font-medium">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Media & Photos
                </a>
                <a href="#section-captions"
                    class="sidebar-link flex items-center px-8 py-3 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white hover:bg-slate-50 dark:hover:bg-zinc-900 transition-all text-sm font-medium">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                    </svg>
                    Captions
                </a>
                <a href="#section-visuals"
                    class="sidebar-link flex items-center px-8 py-3 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white hover:bg-slate-50 dark:hover:bg-zinc-900 transition-all text-sm font-medium">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                    </svg>
                    Visuals & Effects
                </a>
                <a href="#section-audio"
                    class="sidebar-link flex items-center px-8 py-3 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white hover:bg-slate-50 dark:hover:bg-zinc-900 transition-all text-sm font-medium">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19V6l12-3v13M9 10l12-3" />
                    </svg>
                    Background Audio
                </a>
                <a href="#section-uploader"
                    class="sidebar-link flex items-center px-8 py-3 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white hover:bg-slate-50 dark:hover:bg-zinc-900 transition-all text-sm font-medium">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    Cloud Uploader
                </a>
            </div>
        </nav>

        <div class="p-6 border-t border-slate-100 dark:border-zinc-800">
        </div>
        </nav>
        <div class="px-8 pb-8 mt-auto">
            <button id="logout-btn"
                class="w-full flex items-center justify-center space-x-2 py-3 bg-red-50 text-red-600 rounded-lg text-sm font-medium hover:bg-red-100 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div class="flex-1 overflow-auto h-screen relative">
        <!-- Mobile Header -->
        <header
            class="md:hidden h-16 bg-white dark:bg-black border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between px-6 sticky top-0 z-30">
            <button id="mobile-menu-btn" class="p-2 -ml-2 text-zinc-600 dark:text-zinc-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <div class="font-serif font-bold text-lg">Admin Panel</div>
            <div class="w-8"></div>
        </header>

        <!-- VIEW 1: CLIENTS LIST (New Default) -->
        <div id="clients-view" class="p-8 max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800 dark:text-white">Clients</h2>
                    <p class="text-slate-500 dark:text-slate-400">Manage all users and their memory frames.</p>
                </div>
            </div>

            <div
                class="bg-white dark:bg-zinc-900 rounded-xl shadow-sm border border-slate-200 dark:border-zinc-800 overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr
                            class="bg-slate-50 dark:bg-zinc-950/50 border-b border-slate-200 dark:border-zinc-800 text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-semibold">
                            <th class="px-6 py-4">Client Name</th>
                            <th class="px-6 py-4">Email / Mobile</th>
                            <th class="px-6 py-4">Projects</th>
                            <th class="px-6 py-4">Joined</th>
                            <th class="px-6 py-4 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="clients-table-body" class="divide-y divide-slate-100 dark:divide-zinc-800">
                        <tr>
                            <td colspan="5" class="px-6 py-12 text-center text-slate-400">Loading clients...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- VIEW 1.5: CLIENT PROJECTS (New Detail View) -->
        <div id="client-projects-view" class="p-8 max-w-7xl mx-auto hidden">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <button onclick="showClientsView()"
                        class="text-slate-500 hover:text-blue-600 text-sm mb-2 flex items-center">
                        ← Back to Clients
                    </button>
                    <h2 id="cp-client-name" class="text-3xl font-bold text-slate-800 dark:text-white">Client Projects
                    </h2>
                    <p id="cp-client-email" class="text-slate-500 dark:text-slate-400">Viewing projects...</p>
                </div>
            </div>

            <!-- Projects Table -->
            <div
                class="bg-white dark:bg-zinc-900 rounded-xl shadow-sm border border-slate-200 dark:border-zinc-800 overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr
                            class="bg-slate-50 dark:bg-zinc-950/50 border-b border-slate-200 dark:border-zinc-800 text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-semibold">
                            <th class="px-6 py-4">Project / Template</th>
                            <th class="px-6 py-4">Status</th>
                            <th class="px-6 py-4">Created / Updated</th>
                            <th class="px-6 py-4">Payment</th>
                            <th class="px-6 py-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="client-projects-body" class="divide-y divide-slate-100 dark:divide-zinc-800">
                        <tr>
                            <td colspan="5" class="px-6 py-12 text-center text-slate-400">Loading projects...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- VIEW 3: PLANS MANAGEMENT (NEW) -->
        <div id="plans-view" class="p-8 max-w-7xl mx-auto hidden">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800 dark:text-white">Subscription Plans</h2>
                    <p class="text-slate-500 dark:text-slate-400">Manage pricing tiers and validity options.</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Create Plan Form -->
                <div class="lg:col-span-1">
                    <div
                        class="bg-white dark:bg-zinc-900 rounded-xl shadow-sm border border-slate-200 dark:border-zinc-800 p-6">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">Create New Plan</h3>
                        <form id="createPlanForm" class="space-y-6">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Plan
                                    Name</label>
                                <input type="text" name="name" placeholder="e.g. Gold Package" required
                                    class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 text-sm">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Price
                                        (₹)</label>
                                    <input type="number" name="price" placeholder="999" required
                                        class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 text-sm">
                                </div>
                                <div class="md:col-span-2 grid grid-cols-2 gap-2">
                                    <div>
                                        <label
                                            class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Duration
                                            Value</label>
                                        <input type="number" name="durationValue" placeholder="1" required min="1"
                                            class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 text-sm">
                                    </div>
                                    <div>
                                        <label
                                            class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Unit</label>
                                        <select name="durationUnit"
                                            class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 text-sm">
                                            <option value="Months">Months</option>
                                            <option value="Years">Years</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Popular Toggle & Limits -->
                            <div class="flex items-center p-3 bg-slate-50 dark:bg-zinc-800/50 rounded-lg border border-slate-100 dark:border-zinc-800 cursor-pointer hover:bg-slate-100 transition-colors"
                                onclick="document.getElementById('isPopular').click()">
                                <input type="checkbox" name="isPopular" id="isPopular"
                                    class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer pointer-events-auto">
                                <label for="isPopular"
                                    class="ml-3 text-sm text-slate-700 dark:text-slate-300 font-bold uppercase tracking-wide cursor-pointer select-none flex-1">
                                    Mark as "Most Popular"?
                                </label>
                                <span class="text-xs text-slate-400">Adds Gold Badge</span>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Projects</label>
                                    <input type="number" name="projectLimit" placeholder="3"
                                        class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 text-sm">
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Storage
                                        (MB)</label>
                                    <input type="number" name="storageLimit" placeholder="100"
                                        class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 text-sm">
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Video(s)</label>
                                    <input type="number" name="videoDuration" placeholder="60"
                                        class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 text-sm">
                                </div>
                            </div>

                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Features
                                    List (One per line)</label>
                                <textarea name="features" rows="6"
                                    placeholder="Unlimited Photos&#10;No Watermark&#10;Premium Templates"
                                    class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 text-sm resize-none"></textarea>
                            </div>

                            <button type="submit"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors shadow-lg shadow-blue-500/30">
                                Create Plan
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Plans List -->
                <div class="lg:col-span-2">
                    <div
                        class="bg-white dark:bg-zinc-900 rounded-xl shadow-sm border border-slate-200 dark:border-zinc-800 overflow-hidden">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr
                                    class="bg-slate-50 dark:bg-zinc-950/50 border-b border-slate-200 dark:border-zinc-800 text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-semibold">
                                    <th class="px-6 py-4">Plan Name</th>
                                    <th class="px-6 py-4">Price</th>
                                    <th class="px-6 py-4">Storage (MB)</th>
                                    <th class="px-6 py-4">Validity</th>
                                    <th class="px-6 py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="plans-table-body" class="divide-y divide-slate-100 dark:divide-zinc-800">
                                <tr>
                                    <td colspan="4" class="px-6 py-8 text-center text-slate-400">Loading plans...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: EDITOR (Detail View) -->
        <div id="editor-view" class="hidden">
            <!-- Back Button -->
            <div class="max-w-4xl mx-auto pt-8 px-8">
                <button onclick="showDashboard()"
                    class="flex items-center text-sm text-slate-500 hover:text-blue-600 transition-colors mb-4">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Dashboard
                </button>
            </div>

            <form id="configForm" class="max-w-4xl mx-auto py-4 px-8 space-y-16">

                <!-- Sticky Save Header -->
                <div class="fixed top-0 right-0 left-64 bg-white/80 dark:bg-zinc-950/80 backdrop-blur-md border-b border-slate-200 dark:border-zinc-800 z-10 px-8 py-4 flex justify-between items-center transition-all duration-300"
                    id="save-header">
                    <div>
                        <h2 id="current-section-title"
                            class="text-xl font-bold font-serif text-slate-800 dark:text-white">Edit Memory Frame</h2>
                        <p class="text-xs text-slate-500" id="current-project-id">Loading...</p>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" id="resetBtn"
                            class="px-6 py-2 rounded-full border border-slate-200 dark:border-zinc-800 text-slate-500 hover:bg-slate-100 dark:hover:bg-zinc-900 transition-colors text-sm font-medium">
                            Discard
                        </button>
                        <button type="submit" id="save-config-btn"
                            class="px-8 py-2 rounded-full bg-slate-900 hover:bg-black dark:bg-white dark:text-black dark:hover:bg-slate-200 text-white shadow-lg shadow-slate-900/20 transition-all transform hover:scale-105 active:scale-95 font-medium flex items-center">
                            Save Changes
                        </button>
                    </div>
                </div>

                <!-- SECTION 0: ADMIN CONTROLS (NEW) -->
                <section id="section-admin" class="pt-24 pb-8 border-b border-slate-200 dark:border-zinc-800">
                    <div class="flex items-center mb-6">
                        <div class="p-2 bg-purple-100 text-purple-600 rounded-lg mr-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white">Admin Controls</h3>
                    </div>

                    <div
                        class="grid grid-cols-1 md:grid-cols-2 gap-8 bg-purple-50 dark:bg-zinc-900/50 p-6 rounded-2xl border border-purple-100 dark:border-zinc-800">
                        <!-- Status -->
                        <div class="group">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Project
                                Status</label>
                            <select name="admin_status"
                                class="w-full bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 rounded-lg py-3 px-4 font-bold text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-purple-500 transition-all">
                                <option value="active">Active (Visible)</option>
                                <option value="paused">Paused (Hidden)</option>
                            </select>
                        </div>
                        <!-- Validity -->
                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Validity/Plan</label>
                            <select name="admin_validity"
                                class="w-full bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium">
                                <option value="Lifetime">Lifetime</option>
                                <option value="1 Year">1 Year</option>
                                <option value="6 Months">6 Months</option>
                                <option value="1 Month">1 Month</option>
                                <option value="Demo">Demo (7 Days)</option>
                            </select>
                        </div>
                        <!-- Payment Status -->
                        <div class="group">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Payment
                                Status</label>
                            <select name="admin_paymentStatus"
                                class="w-full bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium">
                                <option value="Unpaid">Unpaid</option>
                                <option value="Paid">Paid</option>
                                <option value="Refunded">Refunded</option>
                            </select>
                        </div>
                        <!-- Amount -->
                        <div class="group">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Amount
                                Paid (₹)</label>
                            <input type="number" name="admin_amountPaid" placeholder="0"
                                class="w-full bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-mono">
                        </div>
                        <!-- Client Name (Override) -->
                        <div class="group">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Client
                                Mobile</label>
                            <input type="tel" name="admin_mobile" placeholder="+91..."
                                class="w-full bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-mono">
                        </div>
                        <div class="group">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Client
                                Email</label>
                            <input type="email" name="admin_email" placeholder="client@example.com"
                                class="w-full bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium">
                        </div>
                    </div>
                </section>

                <div class="h-4"></div> <!-- Spacer for Sticky Header -->

                <!-- Template Manager Section -->
                <div id="section-templates"
                    class="bg-white dark:bg-zinc-900 rounded-2xl shadow-sm border border-slate-200 dark:border-zinc-800 p-8 ring-1 ring-slate-900/5 dark:ring-white/10 relative z-0">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800 dark:text-white">Template Library</h2>
                            <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">Select a preset to instantly
                                configure your site.</p>
                        </div>
                        <div class="flex flex-wrap gap-4 w-full md:w-auto">
                            <select id="template-select"
                                class="flex-1 md:flex-none bg-slate-50 dark:bg-zinc-800 border-none rounded-lg px-4 py-2 text-sm text-slate-700 dark:text-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="" disabled selected>Choose a category...</option>
                                <!-- Options loaded dynamically -->
                            </select>
                            <button type="button" onclick="loadSelectedTemplate()"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition-all shadow-lg shadow-blue-500/20 active:scale-95 flex items-center justify-center gap-2 whitespace-nowrap">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                </svg>
                                Load
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section 1: Main Details -->
                <section id="section-main" class="pt-8">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white">1. Client Details</h2>
                        <p class="text-slate-400 text-sm">Basic information used throughout the website.</p>
                    </div>
                    <div
                        class="bg-white dark:bg-black rounded-2xl p-8 shadow-sm border border-slate-100 dark:border-zinc-800 grid grid-cols-1 md:grid-cols-2 gap-8 ring-1 ring-slate-900/5 dark:ring-white/10">
                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Client
                                Names</label>
                            <input type="text" name="title"
                                class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all placeholder:text-slate-300 dark:placeholder:text-zinc-700"
                                placeholder="e.g. John & Jane">
                        </div>
                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Subtitle</label>
                            <input type="text" name="subtitle"
                                class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all placeholder:text-slate-300 dark:placeholder:text-zinc-700"
                                placeholder="e.g. A Sacred Beginning">
                        </div>
                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Event
                                Type</label>
                            <input type="text" name="eventType"
                                class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all placeholder:text-slate-300 dark:placeholder:text-zinc-700"
                                placeholder="e.g. Wedding">
                        </div>
                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Footer
                                Quote</label>
                            <input type="text" name="footerQuote"
                                class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all placeholder:text-slate-300 dark:placeholder:text-zinc-700">
                        </div>
                    </div>
                </section>

                <!-- Section 2: Start Page -->
                <section id="section-start" class="pt-8">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white">2. Start Screen</h2>
                        <p class="text-slate-400 text-sm">The first thing guests see while loading.</p>
                    </div>
                    <div
                        class="bg-white dark:bg-black rounded-2xl p-8 shadow-sm border border-slate-100 dark:border-zinc-800 grid grid-cols-1 md:grid-cols-3 gap-8 ring-1 ring-slate-900/5 dark:ring-white/10">
                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Loading
                                Title</label>
                            <input type="text" name="loadingTitle"
                                class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all">
                        </div>
                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Loading
                                Subtitle</label>
                            <input type="text" name="loadingSubtitle"
                                class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all">
                        </div>
                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Button
                                Label</label>
                            <input type="text" name="enterButtonText"
                                class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all">
                        </div>
                    </div>
                </section>

                <!-- Section 3: Message Section -->
                <section id="section-message" class="pt-8">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white">3. Love Letter</h2>
                        <p class="text-slate-400 text-sm">The heartfelt message at the end of the scroll.</p>
                    </div>
                    <div
                        class="bg-white dark:bg-black rounded-2xl p-8 shadow-sm border border-slate-100 dark:border-zinc-800 space-y-8 ring-1 ring-slate-900/5 dark:ring-white/10">
                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Top
                                Quote (Dedication)</label>
                            <textarea name="dedication" rows="2"
                                class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all resize-none"></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="group">
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Section
                                    Title</label>
                                <input type="text" name="messageTitle"
                                    class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all">
                            </div>
                            <div class="group">
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Sign-Off</label>
                                <input type="text" name="messageSignOff"
                                    class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all">
                            </div>
                            <div class="group">
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Display
                                    Duration (sec)</label>
                                <input type="number" name="visuals.messageDuration" value="8" min="3" max="60"
                                    class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all">
                            </div>
                            <div class="group">
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Section
                                    Music (YouTube URL)</label>
                                <input type="text" name="visuals.messageMusic" placeholder="https://youtu.be/..."
                                    class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all">
                            </div>
                        </div>
                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Main
                                Body Message</label>
                            <textarea name="messageBody" rows="5"
                                class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all"></textarea>
                        </div>
                    </div>
                </section>

                <!-- Section 4: Media -->
                <section id="section-media" class="pt-8">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white">4. Media Assets</h2>
                        <p class="text-slate-400 text-sm">Paths to your images and video links.</p>
                    </div>
                    <div
                        class="bg-white dark:bg-black rounded-2xl p-8 shadow-sm border border-slate-100 dark:border-zinc-800 grid grid-cols-1 md:grid-cols-2 gap-8 ring-1 ring-slate-900/5 dark:ring-white/10">
                        <div class="group md:col-span-2">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">YouTube
                                Embed URL</label>
                            <input type="text" name="youtubeLink"
                                class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all">
                        </div>
                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Hero
                                Image Path</label>
                            <input type="text" name="heroImage"
                                class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all">
                        </div>
                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Photo
                                Count</label>
                            <input type="number" name="photoCount" id="photoCountInput"
                                class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all">
                            <p class="text-[10px] text-slate-400 mt-2">Changing this adds more caption fields below.</p>
                        </div>
                    </div>
                </section>

                <!-- Section 5: Captions -->
                <section id="section-captions" class="pt-8">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white">5. Photo Captions</h2>
                        <p class="text-slate-400 text-sm">One line stories for each memory.</p>
                    </div>
                    <div
                        class="bg-white dark:bg-black rounded-2xl p-8 shadow-sm border border-slate-100 dark:border-zinc-800 ring-1 ring-slate-900/5 dark:ring-white/10">
                        <div id="captionsContainer"
                            class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[500px] overflow-y-auto pr-2 no-scrollbar">
                            <!-- Theme Color -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Theme
                                    Color</label>
                                <div class="flex gap-4 items-center">
                                    <input type="color" name="visuals.themeColor" id="themeColor" value="#C5A059"
                                        class="h-10 w-20 rounded cursor-pointer border-none bg-transparent">
                                    <span class="text-sm text-slate-500 dark:text-slate-400">Pick a primary accent
                                        color</span>
                                </div>
                            </div>

                            <!-- BACKGROUND PATTERN -->
                            <div>
                                <label
                                    class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Background
                                    Pattern</label>
                                <select name="visuals.bgPattern"
                                    class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all">
                                    <option value="mandala">Mandala (Elegant)</option>
                                    <option value="dots">Polka Dots (Fun)</option>
                                    <option value="hearts">Hearts (Romantic)</option>
                                    <option value="grid">Grid (Technical)</option>
                                </select>
                            </div>

                            <!-- FRAME STYLE -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Photo
                                    Frame
                                    Style</label>
                                <select name="visuals.frameStyle"
                                    class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all">
                                    <option value="polaroid">Polaroid (Classic)</option>
                                    <option value="classic">Sharps Border (Formal)</option>
                                    <option value="modern">Rounded Shadow (Modern)</option>
                                    <option value="rose">Ornate Border (Decorative)</option>
                                </select>
                            </div>

                            <!-- FONT THEME -->
                            <div>
                                <label
                                    class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Typography
                                    Theme</label>
                                <select name="visuals.fontTheme"
                                    class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all">
                                    <option value="">Classic (Playfair Display)</option>
                                    <option value="modern">Modern (Montserrat)</option>
                                    <option value="romantic">Romantic (Great Vibes)</option>
                                    <option value="playful">Playful (Pacifico)</option>
                                    <option value="royal">Royal (Cinzel)</option>
                                </select>
                                <p class="text-[10px] text-slate-400 mt-1">Changes headlines and body fonts instantly.
                                </p>
                            </div>

                            <!-- Dynamic Inputs -->
                        </div>
                    </div>
                </section>

                <!-- Section 6: Visuals -->
                <section id="section-visuals" class="pt-8 pb-32">
                    <div class="mb-6 flex items-center">
                        <div
                            class="p-2 bg-gradient-to-tr from-purple-500 to-blue-500 rounded-lg mr-4 text-white shadow-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white">6. Visual FX Engine</h2>
                            <p class="text-slate-400 text-sm">Control the magic.</p>
                        </div>
                    </div>
                    <div
                        class="bg-white dark:bg-black rounded-2xl p-8 shadow-md border border-slate-100 dark:border-zinc-800 grid grid-cols-1 md:grid-cols-2 gap-8 ring-1 ring-blue-500/5 dark:ring-blue-500/10">
                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Interaction
                                Mode</label>
                            <select name="visuals_interactionMode"
                                class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all cursor-pointer">
                                <option value="click">User Click (Classic)</option>
                                <option value="auto">Auto Play (Hands Free)</option>
                            </select>
                        </div>
                        <div class="group">
                            <div class="group" id="photoDurationContainer">
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Photo
                                    Duration (Seconds)</label>
                                <input type="number" name="visuals_photoDuration"
                                    class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all">
                            </div>
                        </div>
                        <div class="group md:col-span-2">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Transition
                                Effect</label>
                            <select name="visuals_transitionEffect"
                                class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all cursor-pointer">
                                <option value="zoom">Gentle Zoom (Classy)</option>
                                <option value="fade">Simple Fade (Minimal)</option>
                                <option value="slideUp">Slide Up (Modern)</option>
                                <option value="slideSide">Slide From Side</option>
                                <option value="rotate">Rotate In (Playful)</option>
                                <option value="blur">Blur Reveal (Dreamy)</option>
                                <option value="polaroid">Falling Polaroid (Bouncy)</option>
                                <option value="flip">3D Flip (Digital)</option>
                                <option value="elastic">Elastic Pop (Fun)</option>
                                <option value="dramatic">Dramatic Burst (Energy)</option>
                            </select>
                        </div>
                    </div>
                </section>

                <!-- Section 7: Audio -->
                <section id="section-audio" class="pt-8 pb-32">
                    <div class="mb-6 flex items-center">
                        <div
                            class="p-2 bg-gradient-to-tr from-pink-500 to-rose-500 rounded-lg mr-4 text-white shadow-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19V6l12-3v13M9 10l12-3" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white">7. Background Audio</h2>
                            <p class="text-slate-400 text-sm">Set the mood with invisible background music.</p>
                        </div>
                    </div>
                    <!-- Photo Base URL (R2 Support) -->
                    <div
                        class="mb-4 bg-white dark:bg-black rounded-2xl p-8 shadow-md border border-slate-100 dark:border-zinc-800 ring-1 ring-blue-500/5 dark:ring-blue-500/10">
                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Photo
                                Storage (Cloudflare R2)</label>
                            <input type="text" name="photoBaseUrl"
                                placeholder="https://pub-xxxx.r2.dev/my-album (Leave empty for local photos)"
                                class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all placeholder:text-slate-300 dark:placeholder:text-zinc-700">
                            <p class="text-[10px] text-slate-400 mt-2">Paste bucket URL to load cloud photos.</p>
                        </div>
                    </div>

                    <!-- YouTube Music Link -->
                    <div
                        class="bg-white dark:bg-black rounded-2xl p-8 shadow-md border border-slate-100 dark:border-zinc-800 ring-1 ring-blue-500/5 dark:ring-blue-500/10">
                        <div class="group">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">YouTube
                                Music Link</label>
                            <input type="text" name="music"
                                class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all placeholder:text-slate-300 dark:placeholder:text-zinc-700"
                                placeholder="https://youtu.be/...">
                            <p class="text-[10px] text-slate-400 mt-2">Will start playing automatically when they enter.
                                Player is hidden.</p>
                        </div>
                    </div>
                </section>

                <!-- Section 8: Cloud Uploader (R2) -->
                <section id="section-uploader" class="pt-8 pb-32 border-t border-slate-200 dark:border-zinc-800 mt-8">
                    <div class="mb-6 flex items-center">
                        <div
                            class="p-2 bg-gradient-to-tr from-cyan-500 to-blue-500 rounded-lg mr-4 text-white shadow-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white">8. Cloud Upload Engine</h2>
                            <p class="text-slate-400 text-sm">Upload directly to Cloudflare R2.</p>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-black rounded-2xl p-8 shadow-md border border-slate-100 dark:border-zinc-800 ring-1 ring-blue-500/5 dark:ring-blue-500/10">

                        <!-- Configuration -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Worker
                                    URL</label>
                                <input type="text" id="worker-url-input"
                                    value="https://qr-memory-uploader.subhojit.workers.dev"
                                    placeholder="https://qr-uploader.your-subdomain.workers.dev"
                                    class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 transition-all text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Auth
                                    Secret</label>
                                <input type="password" id="worker-secret-input" value="qr-admin-secret-2024"
                                    placeholder="Your Secret Key"
                                    class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 transition-all text-sm">
                            </div>
                        </div>

                        <!-- Drop Zone -->
                        <div id="drop-zone"
                            class="border-2 border-dashed border-slate-300 dark:border-zinc-700 rounded-2xl p-12 text-center cursor-pointer hover:bg-slate-50 dark:hover:bg-zinc-900 transition-all group relative overflow-hidden">
                            <input type="file" id="file-upload-input" multiple accept="image/*"
                                class="absolute inset-0 opacity-0 cursor-pointer z-20">

                            <div
                                class="pointer-events-none relative z-10 transition-transform group-hover:scale-105 duration-300">
                                <div
                                    class="w-16 h-16 bg-blue-50 dark:bg-blue-900/20 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-blue-100 dark:group-hover:bg-blue-900/30 transition-colors">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                    </svg>
                                </div>
                                <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200 mb-1">Drop Photos Here
                                </h3>
                                <p class="text-slate-400 text-sm">or click to browse</p>
                            </div>
                        </div>

                        <!-- Upload Queue Status -->
                        <div id="upload-status-area" class="mt-8 hidden">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-bold text-sm text-slate-500 uppercase tracking-wider">Queue</h4>
                                <span id="queue-count"
                                    class="text-xs bg-slate-100 dark:bg-zinc-800 px-2 py-1 rounded text-slate-500">0
                                    Files</span>
                            </div>
                            <div id="upload-list" class="space-y-3 max-h-60 overflow-y-auto pr-2 no-scrollbar">
                                <!-- Dynamic Items -->
                            </div>
                        </div>
                    </div>
                </section>
            </form>
        </div> <!-- End of #editor-view -->
        <!-- VIEW 4: SITE CONTENT (NEW) -->
        <div id="site-content-view" class="p-8 max-w-7xl mx-auto hidden">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800 dark:text-white">Homepage Features</h2>
                    <p class="text-slate-500 dark:text-slate-400">Manage the 'Why Choose Us' section.</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Create Feature Form -->
                <div class="lg:col-span-1">
                    <div
                        class="bg-white dark:bg-zinc-900 rounded-xl shadow-sm border border-slate-200 dark:border-zinc-800 p-6">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">Add Feature Card</h3>
                        <form id="createFeatureForm" class="space-y-6">
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Title</label>
                                <input type="text" name="title" placeholder="e.g. Instant Sharing" required
                                    class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 text-sm">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Description</label>
                                <textarea name="description" rows="3" placeholder="Explain the benefit..." required
                                    class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 text-sm resize-none"></textarea>
                                <p class="text-[10px] text-slate-400 mt-1">Tip: Use <code>{{free_projects}}</code> to
                                    insert dynamic free plan limit.</p>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Icon
                                    (SVG or Emoji)</label>
                                <input type="text" name="icon" placeholder="✨ or <svg>...</svg>" required
                                    class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 text-sm font-mono">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Sort
                                    Order</label>
                                <input type="number" name="order" placeholder="1" value="1" required
                                    class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 text-sm">
                            </div>

                            <button type="submit"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors shadow-lg shadow-blue-500/30">
                                Save Feature
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Features List -->
                <div class="lg:col-span-2">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="features-list">
                        <!-- Dynamic Cards -->
                        <div class="col-span-full py-12 text-center text-slate-400">Loading features...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 4: SITE CONTENT (NEW) -->
        <div id="site-content-view" class="p-8 max-w-7xl mx-auto hidden">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800 dark:text-white">Homepage Features</h2>
                    <p class="text-slate-500 dark:text-slate-400">Manage the 'Why Choose Us' section.</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Create Feature Form -->
                <div class="lg:col-span-1">
                    <div
                        class="bg-white dark:bg-zinc-900 rounded-xl shadow-sm border border-slate-200 dark:border-zinc-800 p-6">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">Add Feature Card</h3>
                        <form id="createFeatureForm" class="space-y-6">
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Title</label>
                                <input type="text" name="title" placeholder="e.g. Instant Sharing" required
                                    class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 text-sm">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Description</label>
                                <textarea name="description" rows="3" placeholder="Explain the benefit..." required
                                    class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 text-sm resize-none"></textarea>
                                <p class="text-[10px] text-slate-400 mt-1">Tip: Use <code>{{free_projects}}</code> to
                                    insert dynamic free plan limit.</p>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Icon
                                    (SVG or Emoji)</label>
                                <input type="text" name="icon" placeholder="✨ or <svg>...</svg>" required
                                    class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 text-sm font-mono">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Sort
                                    Order</label>
                                <input type="number" name="order" placeholder="1" value="1" required
                                    class="w-full bg-slate-50 dark:bg-zinc-800 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-500 text-sm">
                            </div>

                            <button type="submit"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors shadow-lg shadow-blue-500/30">
                                Save Feature
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Features List -->
                <div class="lg:col-span-2">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="features-list">
                        <!-- Dynamic Cards -->
                        <div class="col-span-full py-12 text-center text-slate-400">Loading features...</div>
                    </div>
                </div>
            </div>
        </div>
        </main>

        <!-- Logic -->
        <script type="module">
            import { config } from './config.js';
            import { firebaseConfig } from './js/firebase-config.js';
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
            import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
            import { getFirestore, doc, getDoc, setDoc, addDoc, collection, getDocs, deleteDoc, query, orderBy, onSnapshot, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

            // --- ISOLATED ADMIN INSTANCE ---
            const adminApp = initializeApp(firebaseConfig, "AdminPanel");
            const auth = getAuth(adminApp);
            const db = getFirestore(adminApp);

            // --- SECURITY CHECK (Database Driven) ---
            const loginOverlay = document.getElementById('admin-login-overlay');
            const loginForm = document.getElementById('admin-login-form');
            const loginError = document.getElementById('login-error');
            const loginBtn = document.getElementById('admin-login-btn');

            // View Containers
            const clientsView = document.getElementById('clients-view');
            const clientProjectsView = document.getElementById('client-projects-view');
            const editorView = document.getElementById('editor-view');
            const plansView = document.getElementById('plans-view');
            const siteContentView = document.getElementById('site-content-view');

            // Element Refs
            const clientsTableBody = document.getElementById('clients-table-body');
            const clientProjectsBody = document.getElementById('client-projects-body');
            const plansTableBody = document.getElementById('plans-table-body');
            const featuresList = document.getElementById('features-list');
            const editorNavLinks = document.getElementById('editor-nav-links');

            // --- VIEW SWITCHING ---
            window.showClientsView = () => {
                clientsView.classList.remove('hidden');
                clientProjectsView.classList.add('hidden');
                editorView.classList.add('hidden');
                plansView.classList.add('hidden');
                siteContentView.classList.add('hidden');
                editorNavLinks.classList.add('hidden');
                fetchClients();
            };

            window.showClientProjects = (userId, name, email) => {
                clientsView.classList.add('hidden');
                clientProjectsView.classList.remove('hidden');
                editorView.classList.add('hidden');
                plansView.classList.add('hidden');
                siteContentView.classList.add('hidden');
                document.getElementById('cp-client-name').textContent = name;
                document.getElementById('cp-client-email').textContent = email || "No Email";
                editorNavLinks.classList.add('hidden');
                subscribeToClientProjects(userId);
            };

            window.showPlansView = () => {
                clientsView.classList.add('hidden');
                clientProjectsView.classList.add('hidden');
                editorView.classList.add('hidden');
                plansView.classList.remove('hidden');
                siteContentView.classList.add('hidden');
                editorNavLinks.classList.add('hidden');
                fetchPlans();
            };

            window.showSiteContentView = () => {
                clientsView.classList.add('hidden');
                clientProjectsView.classList.add('hidden');
                editorView.classList.add('hidden');
                plansView.classList.add('hidden');
                siteContentView.classList.remove('hidden');
                editorNavLinks.classList.add('hidden');
                fetchFeatures();
            };

            window.closeEditor = () => {
                showClientsView();
            };

            // Monitor Auth State
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    // Not logged in: Reset button UI
                    loginOverlay.classList.remove('hidden');
                    loginBtn.disabled = false;
                    loginBtn.textContent = "Login";
                } else {
                    console.log("Admin session detected:", user.email);

                    try {
                        // VERIFY ADMIN ROLE FROM DB
                        const adminRef = doc(db, "settings", "admins");
                        const adminSnap = await getDoc(adminRef);

                        let isAuthorized = false;
                        if (adminSnap.exists()) {
                            const adminData = adminSnap.data();
                            const authorizedEmails = (adminData.emails || []).map(e => e.toLowerCase());
                            if (authorizedEmails.includes(user.email.toLowerCase())) {
                                isAuthorized = true;
                            }
                        }

                        if (!isAuthorized) {
                            console.error("Unauthorized admin attempt:", user.email);

                            // Reset login UI for unauthorized user
                            loginBtn.disabled = false;
                            loginBtn.textContent = "Login";
                            loginError.textContent = "Access Denied: Not an Admin";
                            loginError.classList.remove('hidden');

                            alert("Access Denied: Your account is not registered in the admin list.");
                            await auth.signOut();
                            return;
                        }

                        // Authorized
                        loginOverlay.classList.add('hidden');
                        startSessionTimer();

                        // LOAD DEFAULT VIEW
                        showClientsView();

                    } catch (e) {
                        console.error("Auth Verification Error:", e);
                        alert("Security check failed. Please check your connection.");

                        // Reset login UI on error
                        loginBtn.disabled = false;
                        loginBtn.textContent = "Login";

                        await auth.signOut();
                    }
                }
            });

            // --- 1. CLIENTS LOGIC ---
            async function fetchClients() {
                clientsTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400">Loading clients...</td></tr>`;
                try {
                    // Fetch all users
                    const snapshot = await getDocs(collection(db, "users"));
                    clientsTableBody.innerHTML = '';

                    if (snapshot.empty) {
                        clientsTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400">No clients found.</td></tr>`;
                        return;
                    }

                    snapshot.forEach(docSnap => {
                        const user = docSnap.data();
                        const userId = docSnap.id;
                        const joined = user.createdAt
                            ? new Date(user.createdAt.seconds * 1000).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' })
                            : 'N/A';

                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-slate-50 dark:hover:bg-zinc-800/50 transition-colors border-b border-slate-100 dark:border-zinc-800 last:border-0 cursor-pointer";

                        // Simple Stats (mocked for list view speed, real count in detail)
                        tr.innerHTML = `
                         <td class="px-6 py-4 font-bold text-slate-900 dark:text-white">${user.name || "User"}</td>
                         <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-300">
                            <div>${user.email}</div>
                            <div class="text-xs text-slate-400">${user.mobile || ""}</div>
                         </td>
                         <td class="px-6 py-4 text-sm text-slate-600">
                             <span class="bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded-full">View Details</span>
                         </td>
                         <td class="px-6 py-4 text-sm text-slate-500">${joined}</td>
                         <td class="px-6 py-4 text-right">
                            <button class="text-blue-600 hover:underline text-sm font-medium">Manage Projects →</button>
                         </td>
                    `;

                        // Click Row to View Projects
                        tr.addEventListener('click', () => showClientProjects(userId, user.name, user.email));
                        clientsTableBody.appendChild(tr);
                    });

                } catch (e) {
                    console.error("Fetch Clients Error", e);
                    clientsTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-red-500">Error: ${e.message}</td></tr>`;
                }
            }

            // --- 2. REAL-TIME CLIENT PROJECTS ---
            let projectsUnsubscribe = null; // Store listener to detach later

            function subscribeToClientProjects(userId) {
                if (projectsUnsubscribe) projectsUnsubscribe(); // Detach previous

                clientProjectsBody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400">Listening for projects...</td></tr>`;

                const q = query(collection(db, "projects"), where("userId", "==", userId), orderBy("createdAt", "desc"));

                projectsUnsubscribe = onSnapshot(q, (snapshot) => {
                    clientProjectsBody.innerHTML = '';
                    if (snapshot.empty) {
                        clientProjectsBody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400">No projects for this client yet.</td></tr>`;
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const projectId = doc.id;
                        const status = data.status || "active";

                        // Format dates with time
                        const createdAt = data.createdAt
                            ? new Date(data.createdAt.seconds * 1000).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' })
                            : 'N/A';
                        const updatedAt = data.updatedAt
                            ? new Date(data.updatedAt.seconds * 1000).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' })
                            : '—';

                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-slate-50 dark:hover:bg-zinc-800/50 transition-colors border-b border-slate-100 dark:border-zinc-800 last:border-0";
                        tr.innerHTML = `
                        <td class="px-6 py-4">
                            <div class="font-medium text-slate-900 dark:text-white">${data.title}</div>
                            <div class="text-xs text-slate-500">${data.templateId || "Custom"}</div>
                            <div class="text-[10px] text-slate-400 font-mono mt-1">${projectId}</div>
                        </td>
                         <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${status === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${status.toUpperCase()}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <div class="text-slate-600 dark:text-slate-300">${createdAt}</div>
                            <div class="text-xs text-slate-400">Updated: ${updatedAt}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-300">${data.paymentStatus || "unpaid"}</td>
                        <td class="px-6 py-4 text-right space-x-2">
                             <a href="view.html?id=${projectId}" target="_blank" class="text-purple-600 hover:text-purple-800 text-sm font-bold hover:underline mr-2">View Site</a>
                            <button onclick="editProject('${projectId}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium hover:underline">Edit</button>
                            <button onclick="deleteProject('${projectId}')" class="text-red-500 hover:text-red-700 text-sm font-medium hover:underline">Delete</button>
                        </td>
                    `;
                        clientProjectsBody.appendChild(tr);
                    });
                }, (error) => {
                    console.error("Project Realtime Error:", error);
                    if (error.message.includes("requires an index")) {
                        clientProjectsBody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-red-500">Missing Index. <a href="${error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]*/)[0]}" target="_blank" class="underline font-bold">Create Index</a></td></tr>`;
                    } else {
                        clientProjectsBody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-red-500">Error: ${error.message}</td></tr>`;
                    }
                });
            }

            // Action: Edit (Modified to show nav)
            window.editProject = (projectId) => {
                clientsView.classList.add('hidden');
                clientProjectsView.classList.add('hidden');
                plansView.classList.add('hidden');
                editorView.classList.remove('hidden');

                // SHOW Editor Nav
                editorNavLinks.classList.remove('hidden');

                loadConfiguration(projectId);
            };

            // Remove Old Dashboard Logic
            // ... (Cleanup of fetchProjects is implicit as we removed the call)

            // Action: Toggle Status (Pause/Resume)
            window.toggleStatus = async (projectId, newStatus) => {
                if (!confirm(`Are you sure you want to set this project to ${newStatus.toUpperCase()}?`)) return;
                try {
                    await setDoc(doc(db, "projects", projectId), { status: newStatus }, { merge: true });
                    // Optimistic update or refresh
                    refreshDashboard();
                } catch (e) {
                    alert("Failed to update status: " + e.message);
                }
            };

            // Action: Delete
            window.deleteProject = async (projectId) => {
                const confirmDelete = prompt("Type 'DELETE' to confirm removing this project permanently. This CANNOT be undone.");
                if (confirmDelete !== 'DELETE') return;

                try {
                    await deleteDoc(doc(db, "projects", projectId));
                    alert("Project deleted.");
                    refreshDashboard();
                } catch (e) {
                    console.error("Delete failed", e);
                    alert("Delete failed: " + e.message);
                }
            };


            // --- PLANS LOGIC ---
            let editingPlanId = null;

            async function fetchPlans() {
                plansTableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400">Loading plans...</td></tr>`;
                try {
                    // Use onSnapshot for real-time updates so edits reflect instantly
                    const q = query(collection(db, "plans"), orderBy("price", "asc"));
                    onSnapshot(q, (snapshot) => {
                        plansTableBody.innerHTML = '';
                        if (snapshot.empty) {
                            plansTableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400">No active plans found.</td></tr>`;
                            return;
                        }

                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const tr = document.createElement('tr');
                            tr.className = "hover:bg-slate-50 dark:hover:bg-zinc-800/50 transition-colors";
                            tr.innerHTML = `
                            <td class="px-6 py-4 font-medium text-slate-900 dark:text-white">${data.name}</td>
                            <td class="px-6 py-4 text-slate-600 dark:text-slate-300">₹${data.price}</td>
                            <td class="px-6 py-4 text-slate-600 dark:text-slate-300">${data.duration}</td>
                            <td class="px-6 py-4 text-right space-x-2">
                                <button onclick="editPlan('${doc.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium hover:underline">Edit</button>
                                <button onclick="deletePlan('${doc.id}')" class="text-red-500 hover:text-red-700 text-sm font-medium hover:underline">Delete</button>
                            </td>
                        `;
                            plansTableBody.appendChild(tr);
                        });
                    });
                } catch (e) {
                    console.error("Error loading plans", e);
                    plansTableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-red-500">Error: ${e.message}</td></tr>`;
                }
            }

            // Action: Edit Plan (Prepare Form)
            window.editPlan = async (planId) => {
                try {
                    const docSnap = await getDoc(doc(db, "plans", planId));
                    if (!docSnap.exists()) return;

                    const data = docSnap.data();
                    const form = document.getElementById('createPlanForm');

                    form.elements['name'].value = data.name;
                    form.elements['price'].value = data.price;

                    // --- Handle Duration Split (Backwards Compatible) ---
                    if (data.durationValue && data.durationUnit) {
                        form.elements['durationValue'].value = data.durationValue;
                        form.elements['durationUnit'].value = data.durationUnit;
                    } else {
                        // Attempt fallback parse for old "1 Year" strings
                        const parts = (data.duration || "").split(' ');
                        if (parts.length >= 2) {
                            form.elements['durationValue'].value = parts[0];
                            // Normalize unit (remove 's' if needed, or strictly match select options)
                            let unit = parts[1];
                            if (unit.toLowerCase().includes('year')) unit = "Years";
                            if (unit.toLowerCase().includes('month')) unit = "Months";
                            form.elements['durationUnit'].value = unit;
                        }
                    }

                    form.elements['features'].value = (data.features || []).join('\n'); // Join with newlines

                    // New Fields
                    form.elements['projectLimit'].value = data.projectLimit || '';
                    form.elements['storageLimit'].value = data.storageLimit || '';
                    form.elements['videoDuration'].value = data.videoDuration || '';
                    form.elements['isPopular'].checked = !!data.isPopular;

                    // Set Edit Mode
                    editingPlanId = planId;
                    const btn = form.querySelector('button');
                    btn.innerText = "Update Plan";
                    btn.classList.replace('bg-blue-600', 'bg-purple-600');
                    btn.classList.replace('hover:bg-blue-700', 'hover:bg-purple-700');

                    // Scroll to form
                    form.scrollIntoView({ behavior: 'smooth' });

                } catch (e) {
                    console.error(e);
                    alert("Error preparing edit: " + e.message);
                }
            };

            // Action: Create/Update Plan
            document.getElementById('createPlanForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                const originalText = editingPlanId ? "Update Plan" : "Create Plan";
                btn.disabled = true;
                btn.innerText = "Saving...";

                try {
                    const formData = new FormData(e.target);
                    // Parse Features from Textarea (Split by newline, filter empty)
                    const rawFeatures = formData.get('features');
                    const featuresArray = rawFeatures ? rawFeatures.split('\n').map(s => s.trim()).filter(s => s.length > 0) : [];

                    // --- COMBINE DURATION LOGIC ---
                    const dVal = Number(formData.get('durationValue'));
                    const dUnit = formData.get('durationUnit'); // "Months" or "Years"

                    // Display String (e.g. "1 Year" or "6 Months")
                    // Simple pluralization check: if value is 1, maybe drop 's'? 
                    // To keep it simple, we just use the inputs. "1 Years" might look odd but logic is safe.
                    // Let's do a quick fix:
                    let unitDisplay = dUnit;
                    if (dVal === 1 && dUnit.endsWith('s')) unitDisplay = dUnit.slice(0, -1);

                    const durationString = `${dVal} ${unitDisplay}`;

                    // Calculate Duration in Months (for Logic)
                    let months = dVal;
                    if (dUnit === 'Years') months = dVal * 12;

                    const planData = {
                        name: formData.get('name'),
                        price: Number(formData.get('price')),
                        duration: durationString,           // Display
                        durationValue: dVal,                // Raw
                        durationUnit: dUnit,                // Raw
                        durationMonths: months,             // Logic
                        features: featuresArray,
                        // New Fields
                        projectLimit: Number(formData.get('projectLimit')) || 0,
                        storageLimit: Number(formData.get('storageLimit')) || 0,
                        videoDuration: Number(formData.get('videoDuration')) || 0,
                        isPopular: formData.get('isPopular') === 'on',
                        updatedAt: new Date().toISOString()
                    };

                    if (!editingPlanId) {
                        // Create New
                        planData.createdAt = new Date().toISOString();
                        await addDoc(collection(db, "plans"), planData);
                        alert("Plan created successfully!");
                    } else {
                        // Update Existing
                        await setDoc(doc(db, "plans", editingPlanId), planData, { merge: true });
                        alert("Plan updated successfully!");
                    }

                    // Reset Form
                    e.target.reset();
                    editingPlanId = null;
                    btn.innerText = "Create Plan";
                    btn.classList.replace('bg-purple-600', 'bg-blue-600');
                    btn.classList.replace('hover:bg-purple-700', 'hover:bg-blue-700');

                    // Allow manual refresh if needed, but onSnapshot handles the list

                } catch (err) {
                    alert("Error: " + err.message);
                } finally {
                    btn.disabled = false;
                    if (!editingPlanId) btn.innerText = "Create Plan"; // Reset if successful
                }
            });

            // Action: Delete Plan
            window.deletePlan = async (planId) => {
                if (!confirm("Delete this plan? existing users won't be affected.")) return;
                try {
                    await deleteDoc(doc(db, "plans", planId));
                } catch (e) {
                    alert("Delete failed: " + e.message);
                }
            };

            // --- EDITOR DROPDOWN POPULATION ---
            async function populateValidityDropdown() {
                const select = document.querySelector('select[name="admin_validity"]');
                if (!select) return;

                try {
                    const snapshot = await getDocs(collection(db, "plans"));
                    if (snapshot.empty) return; // Keep defaults if no cloud plans

                    // Clear except current value if it's custom? 
                    // Currently replacing all options with fetched ones + defaults maybe?
                    // Let's replace completely, but ensure we have a fallback if none exist.
                    select.innerHTML = '';

                    snapshot.forEach(doc => {
                        const p = doc.data();
                        const opt = document.createElement('option');
                        opt.value = p.name; // Use name as ID for simplicity in this project
                        opt.textContent = `${p.name} (${p.duration})`;
                        select.appendChild(opt);
                    });

                    // Add Hardcoded Fallbacks just in case
                    if (select.options.length === 0) {
                        select.innerHTML = `<option value="Lifetime">Lifetime</option><option value="1 Year">1 Year</option>`;
                    }

                } catch (e) {
                    console.warn("Failed to fetch dynamic plans for dropdown", e);
                }
            }
            let sessionTimeout;
            let warningTimeout;
            const SESSION_DURATION = 5 * 60 * 1000; // 5 Minutes
            const WARNING_TIME = 30 * 1000;         // 30 Seconds before timeout (4m 30s)

            function startSessionTimer() {
                stopSessionTimer(); // Clear existing

                // 1. Warning Timer (at 4m 30s)
                warningTimeout = setTimeout(() => {
                    showSessionWarning();
                }, SESSION_DURATION - WARNING_TIME);

                // 2. Hard Logout Timer (at 5m)
                sessionTimeout = setTimeout(() => {
                    forceLogout();
                }, SESSION_DURATION);

                console.log("Session Timer Started (5m)");
            }

            function stopSessionTimer() {
                clearTimeout(sessionTimeout);
                clearTimeout(warningTimeout);
                hideSessionWarning();
            }

            function forceLogout() {
                alert("Session Expired. Logging out for security.");
                auth.signOut();
                stopSessionTimer();
            }

            // --- SESSION WARNING MODAL ---
            // Dynamically create the modal since it doesn't exist in HTML
            const warningModal = document.createElement('div');
            warningModal.className = "fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden";
            warningModal.innerHTML = `
            <div class="bg-white dark:bg-zinc-900 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center border-2 border-red-500 animate-pulse">
                <div class="text-6xl mb-4">⏳</div>
                <h3 class="text-2xl font-bold text-red-600 mb-2">Session Expiring!</h3>
                <p class="text-slate-600 dark:text-slate-300 mb-8">
                    For security, you will be logged out in <span class="font-bold underline">30 seconds</span>.
                </p>
                <button id="stay-logged-in-btn" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold uppercase tracking-widest transition-colors shadow-lg">
                    Stay Logged In
                </button>
            </div>
        `;
            document.body.appendChild(warningModal);

            function showSessionWarning() {
                warningModal.classList.remove('hidden');
            }

            function hideSessionWarning() {
                warningModal.classList.add('hidden');
            }

            document.getElementById('stay-logged-in-btn').addEventListener('click', () => {
                console.log("User extended session");
                startSessionTimer(); // Reset timer to full 5m
                hideSessionWarning();
            });

            // Handle Admin Login
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('admin-email').value.toLowerCase().trim();
                const password = document.getElementById('admin-password').value;

                loginError.classList.add('hidden');
                loginBtn.disabled = true;
                loginBtn.textContent = "Verifying...";

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // Auth Listener will handle UI update
                } catch (error) {
                    console.error("Login Error:", error);
                    loginError.textContent = "Access Denied: Invalid Credentials";
                    loginError.classList.remove('hidden');
                    loginBtn.disabled = false;
                    loginBtn.textContent = "Login";
                }
            });

            // Handle Manual Logout
            document.getElementById('logout-btn')?.addEventListener('click', () => {
                if (confirm("Are you sure you want to logout?")) {
                    auth.signOut().then(() => {
                        window.location.href = 'index.html';
                    });
                }
            });

            const captionsContainer = document.getElementById('captionsContainer');
            const photoCountInput = document.getElementById('photoCountInput');
            const sectionTitle = document.getElementById('current-section-title');

            // --- MOBILE SIDEBAR LOGIC ---
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const sidebarLinks = document.querySelectorAll('.sidebar-link');

            function toggleSidebar() {
                const isClosed = sidebar.classList.contains('-translate-x-full');
                if (isClosed) {
                    sidebar.classList.remove('-translate-x-full');
                    sidebarOverlay.classList.remove('hidden');
                } else {
                    sidebar.classList.add('-translate-x-full');
                    sidebarOverlay.classList.add('hidden');
                }
            }

            mobileMenuBtn.addEventListener('click', toggleSidebar);
            closeSidebarBtn.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);

            // Auto-close on link click (Mobile)
            sidebarLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 768) { // md breakpoint
                        toggleSidebar();
                    }
                });
            });
            const html = document.documentElement;

            function initTheme() {
                if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }
            }
            initTheme();

            function toggleTheme() {
                if (html.classList.contains('dark')) {
                    html.classList.remove('dark');
                    localStorage.theme = 'light';
                } else {
                    html.classList.add('dark');
                    localStorage.theme = 'dark';
                }
            }

            // Create Toggle Button in Sidebar (REMOVED - MOVED TO TOP BAR)
            window.toggleTheme = toggleTheme;


            // Navigation Highlight
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    sidebarLinks.forEach(l => l.classList.remove('active', 'border-r-4', 'border-blue-600', 'bg-slate-50', 'text-blue-600'));
                    link.classList.add('active', 'border-r-4', 'border-blue-600', 'bg-slate-50', 'text-blue-600');

                    // Update header title based on text
                    sectionTitle.textContent = link.innerText.trim();
                });
            });

            // Helper: Generate Caption Inputs
            function renderCaptionInputs(count) {
                captionsContainer.innerHTML = '';
                for (let i = 1; i <= count; i++) {
                    const div = document.createElement('div');
                    div.className = "group";
                    div.innerHTML = `
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 group-focus-within:text-blue-600 dark:group-focus-within:text-blue-400 transition-colors">Photo ${i}</label>
                    <input type="text" name="caption_${i}" class="w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all placeholder:text-slate-300 dark:placeholder:text-zinc-700" placeholder="Memory details...">
                `;
                    captionsContainer.appendChild(div);
                }
            }

            // --- CUSTOM DROPDOWN LOGIC ---
            function setupCustomDropdowns() {
                const selects = document.querySelectorAll('select');

                selects.forEach(select => {
                    // Return if already processed (check for wrapper or prev sibling)
                    if (select.previousElementSibling && select.previousElementSibling.classList.contains('custom-select-wrapper')) return;

                    // Hide original
                    select.style.display = 'none';

                    // Create Custom Wrapper
                    const wrapper = document.createElement('div');
                    wrapper.className = 'relative w-full custom-select-wrapper';

                    // Custom Button (The "Box")
                    const button = document.createElement('div');
                    button.className = 'w-full bg-slate-50 dark:bg-zinc-900 border-none rounded-lg py-3 px-4 text-slate-700 dark:text-slate-200 font-medium cursor-pointer flex justify-between items-center transition-all hover:bg-slate-100 dark:hover:bg-zinc-800 border-2 border-transparent';

                    // Selected Text span
                    const selectedText = document.createElement('span');
                    selectedText.innerText = select.options[select.selectedIndex]?.text || "Select";
                    button.appendChild(selectedText);

                    // Arrow Icon
                    const arrow = document.createElement('div');
                    arrow.innerHTML = `<svg class="w-4 h-4 text-slate-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>`;
                    button.appendChild(arrow);

                    // Options List container
                    const list = document.createElement('div');
                    list.className = 'absolute z-50 w-full mt-2 bg-white dark:bg-zinc-950 rounded-xl shadow-2xl overflow-hidden hidden opacity-0 translate-y-2 transition-all duration-200 border border-slate-100 dark:border-zinc-800 ring-1 ring-black/5 divide-y divide-slate-50 dark:divide-zinc-900 max-h-64 overflow-y-auto custom-scroll';

                    // Generate Options
                    Array.from(select.options).forEach(option => {
                        const item = document.createElement('div');
                        item.className = `px-4 py-3 cursor-pointer hover:bg-blue-50 dark:hover:bg-zinc-900 transition-colors flex items-center justify-between group ${option.selected ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400' : 'text-slate-600 dark:text-slate-400'}`;

                        // Option Text & Checkmark
                        item.innerHTML = `
                        <span class="font-medium group-hover:text-blue-700 dark:group-hover:text-white">${option.text}</span>
                        ${option.selected ? '<svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>' : ''}
                    `;

                        item.addEventListener('click', () => {
                            // Update real select
                            select.value = option.value;
                            select.dispatchEvent(new Event('change')); // Trigger change event

                            // Update UI text
                            selectedText.innerText = option.text;

                            // Close dropdown
                            toggleDropdown(false);

                            // Re-render options to update active state/checkmark
                            updateOptionsUI();
                        });

                        list.appendChild(item);
                    });

                    function updateOptionsUI() {
                        Array.from(list.children).forEach((child, index) => {
                            const isSelected = select.options[index].value === select.value;
                            child.className = `px-4 py-3 cursor-pointer hover:bg-blue-50 dark:hover:bg-zinc-900 transition-colors flex items-center justify-between group ${isSelected ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400' : 'text-slate-600 dark:text-slate-400'}`;
                            child.innerHTML = `
                            <span class="font-medium group-hover:text-blue-700 dark:group-hover:text-white">${select.options[index].text}</span>
                            ${isSelected ? '<svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>' : ''}
                        `;
                        });
                    }

                    function toggleDropdown(show) {
                        if (show) {
                            list.classList.remove('hidden');
                            // Small delay to allow display:block to apply before opacity transition
                            requestAnimationFrame(() => {
                                list.classList.remove('opacity-0', 'translate-y-2');
                                list.classList.add('opacity-100', 'translate-y-0');
                            });
                            button.classList.add('ring-2', 'ring-blue-100', 'bg-white', 'dark:ring-blue-900', 'dark:bg-zinc-950');
                            arrow.firstElementChild.classList.add('rotate-180');
                        } else {
                            list.classList.remove('opacity-100', 'translate-y-0');
                            list.classList.add('opacity-0', 'translate-y-2');
                            setTimeout(() => list.classList.add('hidden'), 200);
                            button.classList.remove('ring-2', 'ring-blue-100', 'bg-white', 'dark:ring-blue-900', 'dark:bg-zinc-950');
                            arrow.firstElementChild.classList.remove('rotate-180');
                        }
                    }

                    // Toggle logic
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isHidden = list.classList.contains('hidden');
                        // Close others
                        document.querySelectorAll('.custom-select-list').forEach(el => el !== list && el.classList.add('hidden'));

                        toggleDropdown(isHidden);
                    });

                    // Add to DOM
                    list.classList.add('custom-select-list'); // Marker class
                    wrapper.appendChild(button);
                    wrapper.appendChild(list);
                    select.parentNode.insertBefore(wrapper, select);

                    // Listen to external value changes on the real select (e.g. from populateForm)
                    const observer = new MutationObserver(() => {
                        selectedText.innerText = select.options[select.selectedIndex].text;
                        updateOptionsUI();
                    });
                    // We actually just need to hook into when we programmatically change it.
                    // We'll expose a refresh method on the select element itself for convenience.
                    select.refreshCustomUI = () => {
                        selectedText.innerText = select.options[select.selectedIndex]?.text || "Select";
                        updateOptionsUI();
                    }
                });

                // Close when clicking outside
                document.addEventListener('click', (e) => {
                    document.querySelectorAll('.custom-select-list').forEach(list => {
                        if (!list.classList.contains('hidden')) {
                            list.classList.remove('opacity-100', 'translate-y-0');
                            list.classList.add('opacity-0', 'translate-y-2');
                            setTimeout(() => list.classList.add('hidden'), 200);
                            // Reset arrows
                            const wrapper = list.parentElement;
                            const arrow = wrapper.querySelector('svg');
                            if (arrow) arrow.classList.remove('rotate-180');
                            wrapper.firstElementChild.classList.remove('ring-2', 'ring-blue-100', 'bg-white', 'dark:ring-blue-900', 'dark:bg-zinc-950');
                        }
                    });
                });
            }

            // 1. Populate Form
            function populateForm() {
                // Fill standard fields
                for (const [key, value] of Object.entries(config)) {
                    if (key === 'captions') continue;
                    if (key === 'visuals') {
                        // Handle Visuals Object
                        const visuals = value;
                        if (form.elements['visuals_interactionMode']) form.elements['visuals_interactionMode'].value = visuals.interactionMode;
                        if (form.elements['visuals_photoDuration']) form.elements['visuals_photoDuration'].value = visuals.photoDuration;
                        if (form.elements['visuals_transitionEffect']) form.elements['visuals_transitionEffect'].value = visuals.transitionEffect || 'zoom';
                        continue;
                    }

                    const input = form.elements[key];
                    if (input) {
                        input.value = value;
                    }
                }

                // Setup Captions
                const count = Number(config.photoCount) || 0;
                renderCaptionInputs(count);

                // Fill Captions
                if (config.captions) {
                    for (let i = 1; i <= count; i++) {
                        const captionValue = config.captions[String(i)] || "";
                        const input = form.elements[`caption_${i}`];
                        if (input) input.value = captionValue;
                    }
                }

                // --- INITIALIZE CUSTOM DROPDOWN AFTER POPULATION ---
                setupCustomDropdowns();

                // Toggle Duration Field Logic
                const modeSelect = form.elements['visuals_interactionMode'];
                const durationContainer = document.getElementById('photoDurationContainer');

                function toggleDurationField() {
                    if (modeSelect.value === 'click') {
                        durationContainer.style.display = 'none';
                    } else {
                        durationContainer.style.display = 'block';
                    }
                }

                // Listen for changes
                modeSelect.addEventListener('change', toggleDurationField);

                // Initial check
                toggleDurationField();
            }

            // Listen for photo count changes
            photoCountInput.addEventListener('change', (e) => {
                const count = Number(e.target.value);
                renderCaptionInputs(count);
                if (config.captions) {
                    for (let i = 1; i <= count; i++) {
                        const captionValue = config.captions[String(i)] || "";
                        const input = form.elements[`caption_${i}`];
                        if (input) input.value = captionValue;
                    }
                }
            });

            // Global State
            let currentProjectId = null;

            // --- EDITOR LOGIC ---
            window.loadConfiguration = async (projectId) => {
                currentProjectId = projectId;
                document.getElementById('current-project-id').textContent = "Editing Project ID: " + projectId;

                // Show Editor Navigation
                const sidebarNav = document.querySelector('aside nav');
                if (sidebarNav) sidebarNav.classList.remove('hidden');

                // Show loading state if needed

                try {
                    const docRef = doc(db, "projects", projectId);
                    const docSnap = await getDoc(docRef);

                    if (!docSnap.exists()) {
                        alert("Project not found!");
                        showDashboard();
                        return;
                    }

                    const data = docSnap.data();
                    const config = data.config || {};

                    // 1. Populate Admin Fields
                    const form = document.getElementById('configForm');
                    if (form.elements['admin_status']) form.elements['admin_status'].value = data.status || 'active';
                    if (form.elements['admin_validity']) form.elements['admin_validity'].value = data.validity || 'Lifetime';
                    if (form.elements['admin_paymentStatus']) form.elements['admin_paymentStatus'].value = data.paymentStatus || 'Unpaid';
                    if (form.elements['admin_amountPaid']) form.elements['admin_amountPaid'].value = data.amountPaid || '';
                    if (form.elements['admin_mobile']) form.elements['admin_mobile'].value = data.mobile || '';
                    if (form.elements['admin_email']) form.elements['admin_email'].value = data.email || '';

                    // 2. Populate Config Fields
                    populateFormFromData(config);

                    // 3. (NEW) Populate Dynamic Plan Options before setting value
                    await populateValidityDropdown();

                    // Re-set validity value after options population
                    if (form.elements['admin_validity']) form.elements['admin_validity'].value = data.validity || 'Lifetime';

                } catch (e) {
                    console.error("Error loading project:", e);
                    alert("Failed to load project: " + e.message);
                    // Return to appropriate view
                    showClientsView();
                }
            };

            // Helper: Populate form from Config Object
            function populateFormFromData(data) {
                const form = document.getElementById('configForm');
                Array.from(form.elements).forEach(input => {
                    if (input.name.startsWith('admin_')) return;
                    if (!input.name) return;

                    const path = input.name.split('.');
                    let current = data;
                    for (let i = 0; i < path.length; i++) {
                        if (current && current[path[i]] !== undefined) {
                            current = current[path[i]];
                        } else {
                            current = null;
                            break;
                        }
                    }
                    if (current !== null) {
                        input.value = current;
                    }
                });

                if (form.elements['photoCount']) form.elements['photoCount'].dispatchEvent(new Event('change'));
            }

            // --- SAVE LOGIC ---
            const saveBtn = document.getElementById('save-config-btn');
            const originalBtnHtml = saveBtn.innerHTML;

            document.getElementById('configForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentProjectId) return;

                saveBtn.disabled = true;
                saveBtn.innerHTML = "Saving...";

                const form = document.getElementById('configForm');
                const formData = new FormData(form);

                const adminUpdates = {};
                const configUpdates = {};

                const setNested = (obj, path, value) => {
                    const keys = path.split('.');
                    let current = obj;
                    for (let i = 0; i < keys.length - 1; i++) {
                        if (!current[keys[i]]) current[keys[i]] = {};
                        current = current[keys[i]];
                    }
                    current[keys[keys.length - 1]] = value;
                };

                for (const [key, value] of formData.entries()) {
                    if (key.startsWith('admin_')) {
                        const field = key.replace('admin_', '');
                        adminUpdates[field] = value;
                    } else {
                        setNested(configUpdates, key, value);
                    }
                }

                try {
                    await setDoc(doc(db, "projects", currentProjectId), {
                        ...adminUpdates,
                        config: configUpdates
                    }, { merge: true });

                    saveBtn.classList.remove('bg-slate-900', 'hover:bg-black', 'dark:bg-white', 'dark:text-black');
                    saveBtn.classList.add('bg-green-600', 'hover:bg-green-700', 'text-white');
                    saveBtn.innerHTML = `<span>Saved!</span>`;

                    setTimeout(() => {
                        saveBtn.innerHTML = originalBtnHtml;
                        saveBtn.disabled = false;
                        saveBtn.classList.add('bg-slate-900', 'hover:bg-black', 'dark:bg-white', 'dark:text-black');
                        saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700', 'text-white');
                    }, 1500);

                } catch (err) {
                    console.error("Save Error:", err);
                    alert('Failed to save: ' + err.message);
                    saveBtn.innerHTML = originalBtnHtml;
                    saveBtn.disabled = false;
                }
            });

            document.getElementById('resetBtn').addEventListener('click', () => location.reload());

            // --- SITE CONTENT LOGIC ---
            let editingFeatureId = null;

            async function fetchFeatures() {
                const featuresList = document.getElementById('features-list');
                featuresList.innerHTML = `<div class="col-span-full py-12 text-center text-slate-400">Loading content...</div>`;
                try {
                    const q = query(collection(db, "homepage_features"), orderBy("order", "asc"));
                    onSnapshot(q, (snapshot) => {
                        featuresList.innerHTML = '';
                        if (snapshot.empty) {
                            featuresList.innerHTML = `<div class="col-span-full py-12 text-center text-slate-400">No features found. Be the first to add one!</div>`;
                            return;
                        }

                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const div = document.createElement('div');
                            div.className = "group relative bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-800 rounded-xl p-6 hover:border-blue-500 dark:hover:border-blue-500 transition-all";
                            div.innerHTML = `
                             <div class="absolute top-4 right-4 flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="editFeature('${doc.id}')" class="text-blue-500 hover:text-blue-700 bg-blue-50 dark:bg-blue-900/20 p-2 rounded-lg text-xs">
                                    ✏️
                                </button>
                                <button onclick="deleteFeature('${doc.id}')" class="text-red-500 hover:text-red-700 bg-red-50 dark:bg-red-900/20 p-2 rounded-lg text-xs">
                                    🗑️
                                </button>
                             </div>
                             <div class="text-3xl mb-4 text-blue-500">${data.icon || '✨'}</div>
                             <h4 class="font-bold text-slate-900 dark:text-white mb-2">${data.title}</h4>
                             <p class="text-sm text-slate-500 dark:text-slate-400">${data.description}</p>
                             <div class="mt-4 text-xs font-mono text-slate-300">Order: ${data.order}</div>
                        `;
                            featuresList.appendChild(div);
                        });
                    });
                } catch (e) {
                    console.error(e);
                    featuresList.innerHTML = `<div class="text-red-500 col-span-full">Error: ${e.message}</div>`;
                }
            }

            document.getElementById('createFeatureForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                btn.disabled = true;
                btn.innerText = "Saving...";

                try {
                    const formData = new FormData(e.target);
                    const featureData = {
                        title: formData.get('title'),
                        description: formData.get('description'),
                        icon: formData.get('icon'),
                        order: Number(formData.get('order')) || 99,
                        updatedAt: new Date().toISOString()
                    };

                    if (editingFeatureId) {
                        await setDoc(doc(db, 'homepage_features', editingFeatureId), featureData, { merge: true });
                        alert("Feature updated successfully!");
                    } else {
                        featureData.createdAt = new Date().toISOString();
                        await addDoc(collection(db, 'homepage_features'), featureData);
                        alert("Feature added successfully!");
                    }

                    // Reset Mode
                    editingFeatureId = null;
                    e.target.reset();
                    btn.innerText = "Save Feature";
                    btn.classList.remove('bg-purple-600');
                    btn.classList.add('bg-blue-600');

                    // Remove cancel button if exists
                    const cancelBtn = document.getElementById('cancel-edit-feature');
                    if (cancelBtn) cancelBtn.remove();

                } catch (e) {
                    alert("Error: " + e.message);
                } finally {
                    btn.disabled = false;
                    if (!editingFeatureId) btn.innerText = "Save Feature";
                }
            });

            window.editFeature = async (id) => {
                const form = document.getElementById('createFeatureForm');
                try {
                    const docSnap = await getDoc(doc(db, "homepage_features", id));
                    if (!docSnap.exists()) return;

                    const data = docSnap.data();
                    form.elements['title'].value = data.title;
                    form.elements['description'].value = data.description;
                    form.elements['icon'].value = data.icon;
                    form.elements['order'].value = data.order;

                    editingFeatureId = id;

                    // Update UI
                    const btn = form.querySelector('button');
                    btn.innerText = "Update Feature";
                    btn.classList.remove('bg-blue-600');
                    btn.classList.add('bg-purple-600');

                    // Add Cancel Button if not present
                    if (!document.getElementById('cancel-edit-feature')) {
                        const cancelBtn = document.createElement('button');
                        cancelBtn.type = "button";
                        cancelBtn.id = "cancel-edit-feature";
                        cancelBtn.className = "w-full mt-2 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-2 rounded-lg transition-colors";
                        cancelBtn.innerText = "Cancel Edit";
                        cancelBtn.onclick = () => {
                            editingFeatureId = null;
                            form.reset();
                            btn.innerText = "Save Feature";
                            btn.classList.remove('bg-purple-600');
                            btn.classList.add('bg-blue-600');
                            cancelBtn.remove();
                        };
                        form.appendChild(cancelBtn);
                    }

                    form.scrollIntoView({ behavior: 'smooth' });

                } catch (e) {
                    alert("Error loading feature: " + e.message);
                }
            };

            window.deleteFeature = async (id) => {
                if (!confirm("Remove this feature card?")) return;
                try {
                    await deleteDoc(doc(db, 'homepage_features', id));
                } catch (e) {
                    alert("Delete failed: " + e.message);
                }
            };

        </script>
        <script>
            // --- Template Manager Logic ---

            // STATIC LIST: Since GitHub Pages cannot scan directories, we hardcode the list.
            const KNOWN_TEMPLATES = [
                "wedding-template.json",
                "birthday-template.json",
                "bhujono-template.json",
                "birthday-wish-template.json",
                "loveletter-template.json",
                "proposal-template.json",
                "marriage-template.json",
                "achievement-template.json",
                "festival-template.json",
                "party-template.json",
                "portfolio-template.json",
                "anniversary-template.json",
                "custom-template.json"
            ];

            async function fetchTemplates() {
                const select = document.getElementById('template-select');

                // Clear loading state
                if (select.options[0].text === "Loading...") select.innerHTML = '<option value="" disabled selected>Select a Template...</option>';

                KNOWN_TEMPLATES.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    // Format name: "wedding-template.json" -> "Wedding"
                    // Remove "-template.json" and capitalization
                    const label = t.replace('-template.json', '').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    opt.textContent = label;
                    select.appendChild(opt);
                });
            }

            async function loadSelectedTemplate() {
                const name = document.getElementById('template-select').value;
                if (!name) { alert("Please select a template first."); return; }

                if (!confirm("Are you sure? This will overwrite your current settings.")) return;

                try {
                    // DIRECT FILE FETCH: Works on GitHub Pages (Static) AND Localhost
                    const res = await fetch(`clients/${name}`);
                    if (!res.ok) throw new Error(`Failed to load ${name}`);
                    const data = await res.json();

                    // Populate Form
                    populateFormFromTemplate(data); // Reuse existing function

                    // Alert with "Save" Reminder
                    alert(`Loaded "${name}"!\n\nthemeColor: ${data.visuals?.themeColor || 'Default'}\n\nReview the settings and click 'Save Changes' to apply.`);

                } catch (e) {
                    alert("Error loading template: " + e.message);
                    console.error(e);
                }
            }

            // Helper: Recursively populate form fields from template data
            function populateFormFromTemplate(data) {
                const form = document.getElementById('configForm');
                // Find all inputs with a 'name' attribute
                const inputs = form.querySelectorAll('[name]');

                inputs.forEach(input => {
                    const path = input.name.split('.');
                    let current = data;

                    // Traverse JSON path (e.g. visuals.themeColor)
                    for (let i = 0; i < path.length; i++) {
                        if (current && current[path[i]] !== undefined) {
                            current = current[path[i]];
                        } else {
                            current = null;
                            break;
                        }
                    }

                    // Set value if found
                    if (current !== null) {
                        input.value = current;
                        // Trigger visual update (if any listeners exist)
                        input.dispatchEvent(new Event('change'));
                    }
                });
            }

            // Initialize
            fetchTemplates();
            // --- 8. CLOUD UPLOADER LOGIC ---
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-upload-input');
            const workerUrlInput = document.getElementById('worker-url-input');
            const workerSecretInput = document.getElementById('worker-secret-input');
            const uploadStatusArea = document.getElementById('upload-status-area');
            const uploadList = document.getElementById('upload-list');
            const queueCount = document.getElementById('queue-count');

            // Load Saved Settings
            if (localStorage.getItem('workerUrl')) workerUrlInput.value = localStorage.getItem('workerUrl');
            if (localStorage.getItem('workerSecret')) workerSecretInput.value = localStorage.getItem('workerSecret');

            // Save on Change
            workerUrlInput.addEventListener('change', () => localStorage.setItem('workerUrl', workerUrlInput.value));
            workerSecretInput.addEventListener('change', () => localStorage.setItem('workerSecret', workerSecretInput.value));

            // File Handling
            fileInput.addEventListener('change', handleFiles);

            function handleFiles(e) {
                const files = e.target.files;
                processQueue(files);
            }

            async function processQueue(files) {
                uploadStatusArea.classList.remove('hidden');
                queueCount.textContent = `${files.length} Files`;

                const workerUrl = workerUrlInput.value.replace(/\/$/, ""); // Remove trailing slash
                const secret = workerSecretInput.value;

                if (!workerUrl || !secret) {
                    alert("Please configure Worker URL and Secret first.");
                    return;
                }

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const id = `file-${Date.now()}-${i}`;

                    // Add to UI
                    const item = document.createElement('div');
                    item.className = "flex items-center gap-4 bg-slate-50 dark:bg-zinc-900 p-3 rounded-lg border border-slate-100 dark:border-zinc-800 text-sm";
                    item.innerHTML = `
                    <div class="w-8 h-8 bg-slate-200 dark:bg-zinc-800 rounded flex items-center justify-center text-xs font-bold text-slate-500">
                        ${file.type.includes('image') ? 'IMG' : 'FILE'}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="truncate font-medium text-slate-700 dark:text-slate-200">${file.name}</p>
                        <p class="text-xs text-slate-400">${(file.size / 1024).toFixed(0)} KB</p>
                    </div>
                    <div id="status-${id}" class="text-xs font-bold text-slate-400">WAITING</div>
                `;
                    uploadList.appendChild(item);

                    // Upload
                    await uploadFile(file, workerUrl, secret, id);
                }
            }

            async function uploadFile(file, workerUrl, secret, uiId) {
                const statusEl = document.getElementById(`status-${uiId}`);
                statusEl.textContent = "UPLOADING...";
                statusEl.className = "text-xs font-bold text-blue-500 animate-pulse";

                try {
                    // Construct URL: worker/upload?key=filename
                    // Use original name for simplicity, or sanitize
                    const key = encodeURIComponent(file.name); // Using simple name preserve

                    const response = await fetch(`${workerUrl}/upload?key=${key}`, {
                        method: 'PUT',
                        headers: {
                            'X-Auth-Secret': secret,
                            'Content-Type': file.type
                        },
                        body: file
                    });

                    if (!response.ok) throw new Error(await response.text());

                    const result = await response.json();
                    statusEl.textContent = "DONE";
                    statusEl.className = "text-xs font-bold text-green-500";
                } catch (e) {
                    console.error(e);
                    statusEl.textContent = "FAILED";
                    statusEl.className = "text-xs font-bold text-red-500";
                    statusEl.title = e.message;
                }
            }
        </script>
</body>

</html>